<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malayalam Letter Tracing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; overflow-x: hidden; }
        .malayalam-font { font-family: 'Arial', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .letter-outline {
            font-size: 250px;
            font-weight: bold;
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 2;
            pointer-events: none;
        }
        .shining-ray:hover::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shine 0.8s;
        }
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        #tracing-canvas { touch-action: none; cursor: crosshair; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-blue-50 text-slate-800 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto min-h-screen flex flex-col">
        </div>

    <script>
        // Data Structures
        const DATA = {
            vowels: [
                { id: 'v1', char: 'അ' }, { id: 'v2', char: 'ആ' }, { id: 'v3', char: 'ഇ' },
                { id: 'v4', char: 'ഈ' }, { id: 'v5', char: 'ഉ' }, { id: 'v6', char: 'ഊ' },
                { id: 'v7', char: 'ഋ' }, { id: 'v8', char: 'എ' }, { id: 'v9', char: 'ഏ' },
                { id: 'v10', char: 'ഐ' }, { id: 'v11', char: 'ഒ' }, { id: 'v12', char: 'ഓ' },
                { id: 'v13', char: 'ഔ' }
            ],
            consonants: [
                { id: 'c1', char: 'ക' }, { id: 'c2', char: 'ഖ' }, { id: 'c3', char: 'ഗ' },
                { id: 'c4', char: 'ഘ' }, { id: 'c5', char: 'ങ' }, { id: 'c6', char: 'ച' },
                { id: 'c7', char: 'ഛ' }, { id: 'c8', char: 'ജ' }, { id: 'c9', char: 'ഝ' },
                { id: 'c10', char: 'ഞ' }
            ]
        };

        // App State
        let state = {
            view: 'welcome',
            category: null,
            currentLetterId: null,
            completedLetters: JSON.parse(localStorage.getItem('ml_completed')) || [],
            brushColor: '#3b82f6',
            brushSize: 15
        };

        const app = document.getElementById('app');

        // Router / View Controller
        function setView(view, params = {}) {
            state.view = view;
            Object.assign(state, params);
            render();
            window.scrollTo(0, 0);
        }

        function saveProgress(id) {
            if (!state.completedLetters.includes(id)) {
                state.completedLetters.push(id);
                localStorage.setItem('ml_completed', JSON.stringify(state.completedLetters));
            }
        }

        // --- Renderers ---

        function render() {
            app.innerHTML = '';
            if (state.view === 'welcome') renderWelcome();
            else if (state.view === 'category') renderCategory();
            else if (state.view === 'list') renderList();
            else if (state.view === 'tracing') renderTracing();
            lucide.createIcons();
        }

        function renderWelcome() {
            app.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center text-center p-6">
                    <h1 class="text-4xl md:text-6xl font-extrabold mb-2 text-blue-600">Let's Learn Malayalam Letters</h1>
                    <h2 class="text-3xl md:text-5xl font-bold mb-12 text-slate-700">മലയാളം അക്ഷരങ്ങൾ പഠിക്കാം</h2>
                    
                    <button onclick="setView('category')" class="group relative overflow-hidden bg-blue-600 text-white px-12 py-4 rounded-full text-2xl font-bold shadow-lg hover:scale-105 transition-all">
                        <span class="inline-block group-hover:hidden">Shall We Begin?</span>
                        <span class="hidden group-hover:inline-block">തുടങ്ങാം?</span>
                    </button>
                </div>
            `;
        }

        function renderCategory() {
            app.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center p-6">
                    <h2 class="text-3xl font-bold mb-12">What would you like to learn?</h2>
                    <div class="flex flex-col md:flex-row gap-8 w-full max-w-2xl">
                        <button onclick="setView('list', {category: 'vowels'})" class="group flex-1 bg-white border-4 border-blue-400 p-10 rounded-3xl shadow-xl hover:bg-blue-400 hover:text-white transition-all text-3xl font-bold">
                            <span class="group-hover:hidden">Vowels</span>
                            <span class="hidden group-hover:inline-block">സ്വരാക്ഷരങ്ങൾ</span>
                        </button>
                        <button onclick="setView('list', {category: 'consonants'})" class="group flex-1 bg-white border-4 border-emerald-400 p-10 rounded-3xl shadow-xl hover:bg-emerald-400 hover:text-white transition-all text-3xl font-bold">
                            <span class="group-hover:hidden">Consonants</span>
                            <span class="hidden group-hover:inline-block">വ്യഞ്ജനാക്ഷരങ്ങൾ</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderList() {
            const letters = DATA[state.category];
            const title = state.category === 'vowels' ? 'Vowels / സ്വരാക്ഷരങ്ങൾ' : 'Consonants / വ്യഞ്ജനാക്ഷരങ്ങൾ';
            
            let gridHtml = letters.map(l => {
                const isDone = state.completedLetters.includes(l.id);
                return `
                    <div onclick="setView('tracing', {currentLetterId: '${l.id}'})" 
                         class="shining-ray relative cursor-pointer bg-white aspect-square flex items-center justify-center rounded-2xl shadow-md border-4 transition-all hover:scale-110 
                         ${isDone ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'}">
                        <span class="text-5xl font-bold ${isDone ? 'text-emerald-700' : 'text-slate-700'}">${l.char}</span>
                        ${isDone ? '<div class="absolute top-2 right-2 text-emerald-600"><i data-lucide="check-circle-2"></i></div>' : ''}
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <header class="p-6 flex items-center justify-between">
                    <button onclick="setView('category')" class="p-2 hover:bg-slate-200 rounded-full transition-all"><i data-lucide="arrow-left"></i></button>
                    <h2 class="text-2xl font-bold">${title}</h2>
                    <div class="w-10"></div>
                </header>
                <div class="p-6 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                    ${gridHtml}
                </div>
            `;
        }

        function renderTracing() {
            const allLetters = DATA[state.category];
            const letter = allLetters.find(l => l.id === state.currentLetterId);
            const isDone = state.completedLetters.includes(letter.id);

            app.innerHTML = `
                <div class="flex flex-col h-screen">
                    <header class="p-4 flex items-center justify-between bg-white shadow-sm">
                        <button onclick="setView('list')" class="flex items-center gap-2 text-slate-600"><i data-lucide="chevron-left"></i> Back</button>
                        <h2 class="text-xl font-bold">Trace: ${letter.char}</h2>
                        <button id="next-btn" class="${isDone ? '' : 'hidden'} bg-emerald-500 text-white px-6 py-2 rounded-full font-bold shadow-lg" onclick="handleNext()">
                            ${allLetters.indexOf(letter) === allLetters.length -1 ? 'Finish' : 'Next'}
                        </button>
                    </header>

                    <div class="flex-1 flex flex-col md:flex-row">
                        <div class="flex-1 relative bg-white flex items-center justify-center overflow-hidden p-4">
                            <canvas id="tracing-canvas" class="z-10"></canvas>
                            <canvas id="ref-canvas" class="hidden"></canvas>
                            
                            <div id="success-overlay" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/50 backdrop-blur-sm">
                                <div class="text-emerald-500 scale-0 transition-transform duration-500" id="success-check">
                                    <i data-lucide="check-circle" size="120"></i>
                                </div>
                            </div>
                        </div>

                        <div class="w-full md:w-64 bg-slate-100 p-6 flex md:flex-col gap-6 items-center border-t md:border-t-0 md:border-l border-slate-200">
                            <div class="flex-1 md:w-full">
                                <label class="text-sm font-bold text-slate-500 block mb-2">Color</label>
                                <div class="flex gap-2 flex-wrap">
                                    ${['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'].map(c => `
                                        <div onclick="state.brushColor='${c}'" class="w-8 h-8 rounded-full cursor-pointer border-2 border-white shadow-sm" style="background:${c}"></div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="flex-1 md:w-full">
                                <label class="text-sm font-bold text-slate-500 block mb-2">Size</label>
                                <input type="range" min="10" max="40" value="${state.brushSize}" oninput="state.brushSize=this.value" class="w-full">
                            </div>
                            <button onclick="initCanvas()" class="flex items-center gap-2 bg-white border border-slate-300 px-4 py-2 rounded-lg hover:bg-slate-50">
                                <i data-lucide="refresh-cw" size="18"></i> Retry
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => initCanvas(), 50);
        }

        // --- Tracing Logic ---

        let ctx, refCtx, canvas, refCanvas;
        let drawing = false;
        let totalPixels = 0;
        let filledPixels = 0;

        function initCanvas() {
            canvas = document.getElementById('tracing-canvas');
            refCanvas = document.getElementById('ref-canvas');
            if(!canvas) return;

            const size = Math.min(canvas.parentElement.offsetWidth, canvas.parentElement.offsetHeight) - 40;
            canvas.width = canvas.height = refCanvas.width = refCanvas.height = size;
            
            ctx = canvas.getContext('2d');
            refCtx = refCanvas.getContext('2d');

            const letter = DATA[state.category].find(l => l.id === state.currentLetterId).char;

            // Prepare Reference (the "Hitbox")
            refCtx.fillStyle = "black";
            refCtx.font = `bold ${size * 0.8}px Arial`;
            refCtx.textAlign = "center";
            refCtx.textBaseline = "middle";
            refCtx.fillText(letter, size/2, size/2);

            // Draw Outline on Main Canvas
            ctx.strokeStyle = "#e2e8f0";
            ctx.lineWidth = 2;
            ctx.font = `bold ${size * 0.8}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.strokeText(letter, size/2, size/2);

            // Calculate total area for completion
            const imgData = refCtx.getImageData(0, 0, size, size).data;
            totalPixels = 0;
            for(let i=3; i<imgData.length; i+=4) if(imgData[i] > 0) totalPixels++;
            filledPixels = 0;

            // Events
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
            canvas.addEventListener('touchend', endDraw);
        }

        function startDraw(e) { drawing = true; draw(e); }
        function endDraw() { 
            drawing = false; 
            ctx.beginPath();
            checkCompletion();
        }

        function draw(e) {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;

            // Boundary Check: Is current point inside the black reference?
            const pixel = refCtx.getImageData(x, y, 1, 1).data;
            if (pixel[3] > 0) { // Alpha > 0
                ctx.lineWidth = state.brushSize;
                ctx.lineCap = 'round';
                ctx.strokeStyle = state.brushColor;

                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
        }

        function checkCompletion() {
            const currentData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const refData = refCtx.getImageData(0, 0, canvas.width, canvas.height).data;
            
            let filled = 0;
            for(let i=3; i<refData.length; i+=4) {
                if(refData[i] > 0 && currentData[i] > 0) filled++;
            }

            const percent = (filled / totalPixels) * 100;
            if (percent > 80) triggerSuccess();
        }

        function triggerSuccess() {
            saveProgress(state.currentLetterId);
            document.getElementById('success-overlay').classList.remove('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
            
            const check = document.getElementById('success-check');
            setTimeout(() => check.style.transform = 'scale(1)', 50);

            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });

            // Solid Fill
            const size = canvas.width;
            ctx.fillStyle = "#10b981";
            ctx.fillText(DATA[state.category].find(l => l.id === state.currentLetterId).char, size/2, size/2);
        }

        function handleNext() {
            const allLetters = DATA[state.category];
            const currentIndex = allLetters.findIndex(l => l.id === state.currentLetterId);
            
            if (currentIndex < allLetters.length - 1) {
                setView('tracing', { currentLetterId: allLetters[currentIndex + 1].id });
            } else {
                setView('category');
            }
        }

        // Init
        render();
    </script>
</body>
</html>
